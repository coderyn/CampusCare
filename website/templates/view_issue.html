{% extends "base.html" %}

{% block title %}{{ issue.title }}{% endblock %}

{% block content %}
<div class="card">
    <div class="issue-header">
        <h1>{{ issue.title }}</h1>
        <span class="status-badge {{ issue.status|get_status_color }}">{{ issue.status }}</span>
    </div>
    
    <div class="issue-details">
        <div class="detail-item">
            <strong><i class="fas fa-layer-group"></i> Category:</strong>
            <span class="category-tag">{{ issue.category }}</span>
        </div>
        
        <div class="detail-item">
            <strong><i class="fas fa-map-marker-alt"></i> Location:</strong>
            <span>{{ issue.location }}</span>
        </div>
        
        <div class="detail-item">
            <strong><i class="fas fa-exclamation-triangle"></i> Priority:</strong>
            <span class="priority-badge {{ issue.priority|get_priority_color }}">{{ issue.priority }}</span>
        </div>
        
        <div class="detail-item">
            <strong><i class="fas fa-calendar"></i> Reported:</strong>
            <span>{{ issue.created_at|format_date }}</span>
        </div>
        
        {% if issue.department %}
        <div class="detail-item">
            <strong><i class="fas fa-building"></i> Department:</strong>
            <span>{{ issue.department }}</span>
        </div>
        {% endif %}
    </div>
    
    <div class="issue-description">
        <h3><i class="fas fa-file-alt"></i> Description</h3>
        <p>{{ issue.description }}</p>
    </div>

    {% if issue.image_filename %}
    <div class="issue-image">
    <h3><i class="fas fa-image"></i> Attached Image</h3>
    <img src="{{ url_for('static', filename='uploads/' ~ issue.image_filename) }}"
         alt="Issue Image"
         class="issue-img">
    </div>
    {% endif %}

    <!-- comments section -->
<div class="issue-comments">
    <h3><i class="fas fa-comments"></i> Comments</h3>

    {% set my_tokens = session.get('my_comment_tokens', []) %}

    {% if issue.comments %}
        <ul class="comment-list">
            {% for comment in issue.comments %}
    <li class="comment-item">
    <div class="comment-header">

        <div class="comment-username">
            {{ comment.user.username }}
        </div>
        
        <span class="comment-text">{{ comment.content }}</span>

        {% if comment.edit_token in my_tokens %}
        <div class="comment-actions">
            <span class="dots">⋮</span>

            <div class="dropdown-menu">
                <a href="{{ url_for('edit_comment', comment_id=comment.id) }}"> Edit</a>

                <form action="{{ url_for('delete_comment', comment_id=comment.id) }}"
                      method="POST">
                    <button type="submit"
                            onclick="return confirm('Delete this comment?')">
                         Delete
                    </button>
                </form>
            </div>
        </div>
        {% endif %}
    </div>
</li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No comments yet. Be the first to comment!</p>
    {% endif %}

    <!-- Comment form stays below -->
    <form method="POST" class="comment-form">
        <div class="form-group">
            <label for="comment">
                <i class="fas fa-comment-dots"></i> Add a comment
            </label>
            <textarea id="comment" name="comment" rows="3"
                      class="form-textarea"
                      placeholder="Write your comment here..."
                      required></textarea>
        </div>

        <button type="submit" class="btn btn-primary btn-sm">
            <i class="fas fa-paper-plane"></i> Post Comment
        </button>
    </form>
</div>

{% if issue.status == 'Resolved' %}
<div class="issue-rating">
  <h3><i class="fas fa-star"></i> Satisfaction Rating</h3>

  {% if avg_rating %}
    <div class="avg-stars">
      {% for i in range(1, 6) %}
        {% if i <= avg_rating|round(0, 'floor') %}
          ★
        {% else %}
          ☆
        {% endif %}
      {% endfor %}
    </div>
    <p>{{ avg_rating }}/5 ({{ rating_count }} ratings)</p>
  {% endif %}

  <form method="POST" action="{{ url_for('rate_issue', issue_id=issue.id) }}">
    <label>Rate the solution:</label><br>

    <!-- ⭐ Star input -->
    <div class="star-rating">
      <input type="radio" id="star5" name="rating" value="5" required>
      <label for="star5">★</label>
      <input type="radio" id="star4" name="rating" value="4">
      <label for="star4">★</label>
      <input type="radio" id="star3" name="rating" value="3">
      <label for="star3">★</label>
      <input type="radio" id="star2" name="rating" value="2">
      <label for="star2">★</label>
      <input type="radio" id="star1" name="rating" value="1">
      <label for="star1">★</label>
    </div>

    <div class="form-group">
      <textarea name="feedback" rows="3"
                class="form-textarea"
                placeholder="Optional feedback"></textarea>
    </div>

    <div class="rating-actions">
    <button type="submit" class="btn btn-primary btn-sm">
        Submit
    </button>
</div>
  </form>
</div>
{% endif %}

    
    <div class="issue-actions">
        <a href="{{ url_for('issues_list') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Issues
        </a>
    </div>
</div>
{% endblock %}