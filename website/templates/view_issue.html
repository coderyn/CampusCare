{% extends "base.html" %}

{% block title %}{{ issue.title }}{% endblock %}

{% block content %}
<div class="card">
    <div class="issue-header">
        <h1>{{ issue.title }}</h1>
        <span class="status-badge {{ issue.status|get_status_color }}">{{ issue.status }}</span>
    </div>
    
    <div class="issue-details">
        <div class="detail-item">
            <strong><i class="fas fa-layer-group"></i> Category:</strong>
            <span class="category-tag">{{ issue.category }}</span>
        </div>
        
        <div class="detail-item">
            <strong><i class="fas fa-map-marker-alt"></i> Location:</strong>
            <span>{{ issue.location }}</span>
        </div>
        
        <div class="detail-item">
            <strong><i class="fas fa-exclamation-triangle"></i> Priority:</strong>
            <span class="priority-badge {{ issue.priority|get_priority_color }}">{{ issue.priority }}</span>
        </div>
        
        <div class="detail-item">
            <strong><i class="fas fa-calendar"></i> Reported:</strong>
            <span>{{ issue.created_at|format_date }}</span>
        </div>
        
        {% if issue.department %}
        <div class="detail-item">
            <strong><i class="fas fa-building"></i> Department:</strong>
            <span>{{ issue.department }}</span>
        </div>
        {% endif %}
    </div>
    
    <div class="issue-description">
        <h3><i class="fas fa-file-alt"></i> Description</h3>
        <p>{{ issue.description }}</p>
    </div>

    {% if issue.image_filename %}
    <div class="issue-image">
    <h3><i class="fas fa-image"></i> Attached Image</h3>
    <img src="{{ url_for('static', filename='uploads/' ~ issue.image_filename) }}"
         alt="Issue Image"
         class="issue-img">
    </div>
    {% endif %}

    <!-- comments section -->
<div class="issue-comments">
    <h3><i class="fas fa-comments"></i> Comments</h3>

    {% set my_tokens = session.get('my_comment_tokens', []) %}

    {% if issue.comments %}
        <ul class="comment-list">
            {% for comment in issue.comments %}
                <li class="comment-item">
                    <div class="comment-content">
                        {{ comment.content }}
                    </div>

                    {% if comment.edit_token in my_tokens %}
                        <div style="margin-top: 6px;">
                            <a class="btn btn-sm btn-outline-secondary"
                               href="{{ url_for('edit_comment', comment_id=comment.id) }}">
                                Edit
                            </a>

                            <form action="{{ url_for('delete_comment', comment_id=comment.id) }}"
                                  method="POST" style="display:inline;">
                                <button class="btn btn-sm btn-outline-danger"
                                        onclick="return confirm('Delete this comment?')">
                                    Delete
                                </button>
                            </form>
                        </div>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No comments yet. Be the first to comment!</p>
    {% endif %}

    <!-- Comment form stays below -->
    <form method="POST" class="comment-form">
        <div class="form-group">
            <label for="comment">
                <i class="fas fa-comment-dots"></i> Add a comment
            </label>
            <textarea id="comment" name="comment" rows="3"
                      class="form-textarea"
                      placeholder="Write your comment here..."
                      required></textarea>
        </div>

        <button type="submit" class="btn btn-primary btn-sm">
            <i class="fas fa-paper-plane"></i> Post Comment
        </button>
    </form>
</div>

    
    <div class="issue-actions">
        <a href="{{ url_for('issues_list') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Issues
        </a>
    </div>
</div>
{% endblock %}